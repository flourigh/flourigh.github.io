<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<!-- AngularJS -->
	<script src="https://code.angularjs.org/1.6.9/angular.min.js"></script>
<!-- AngularJS -->

<!-- Materia design lite -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
	<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue_grey-red.min.css" />
	<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<!-- material design lite -->

<div ng-app="Text_Strings" ng-controller="Text_Lists">

			<form class="search-f" autocomplete="off">
				<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				  <input class="mdl-textfield__input search-q" autofocus value="{{searchQuery}}"/>
				  <label class="mdl-textfield__label">{{searchImput}}</label>
				</div>

				<button class="mdl-button mdl-js-button mdl-button--colored">
					<i class="material-icons">search</i>
				</button>
			</form>

			<div class="search-e">
				<div class="video">
					
				</div>
			</div>

			<div class="search-l">
				<div class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>
			</div>

			<div class="search-r"></div>

			<button class="keyboard_arrow_left mdl-button mdl-js-button mdl-button--colored">
				<i class="material-icons">keyboard_arrow_left</i>
			</button>
			<button class="keyboard_arrow_right mdl-button mdl-js-button mdl-button--colored">
				<i class="material-icons">keyboard_arrow_right</i>
			</button>

</div>

<script>

    angular.module('Text_Strings', []).controller('Text_Lists', function($scope) {

		$scope.searchImput = 'Pesquisar'
		$scope.searchQuery = getWindowLocation("history") ? getWindowLocation("history") : getWindowLocation("search")

    })

	$.fn.extend({
		qcss: function(css) {
			return $(this).queue(function(next) {
				$(this).css(css)
				next()
			})
		}
	})

	function getWindowLocation(a) {
		//console.log(a)

		function urlDecode(a, b) {
			if(!a || !a.length) {
				return {} }

			var r = {}, c = a.split('&'), d, e, f, g = /\+/g;

			for(var i = 0, l = c.length; i < l; i++) {
				d = c[i].split('=')
				e = unescape(d[0])
				f = unescape(d[1]).replace(g, ' ')
				if(b !== true) {
					if(typeof r[e] == 'undefined') {
						r[e] = f
					} else if(typeof r[e] == 'string') {
						r[e] = [r[e]]
						r[e].push(f)
					} else {
						r[e].push(f) }
				} else {
					r[e] = f } }
			return r
		}

		return(urlDecode(window.location.href.substring(window.location.href.indexOf("?")+1))[a])
	}

	var key = "AIzaSyBTOfZRh_vFnNr9NPJiVOLxJQ5Krj7oK8g";
	var part = "id,snippet";
	var maxResults = 7;
	var playlistId, nextPageToken, prevPageToken;

	getWindowLocation("videoid") ? console.log('videoid 1') : console.log('videoid 0')
	getWindowLocation("search") ? changeSearchState() : console.log('search 0')
	getWindowLocation("history") ? changeSearchState() : console.log('history 0')

	$(document).on("click", "x", function() {
		history.pushState(getWindowLocation("search"), getWindowLocation("search"), "?history=" + getWindowLocation("search"));
		$(".search-q").attr('value', getWindowLocation("search") );
		changeSearchState()
	})

	function changeSearchState() {
		$('.search-f').qcss({
			display: getWindowLocation("videoid") ? 'none' : 'block'
		})
		$('.search-e').qcss({
			display: getWindowLocation("videoid") ? 'block' : 'none'
		})

		if(getWindowLocation("history") !== undefined) {
			displayLoader()
			requestVideoPlaylist(getWindowLocation("history"), playlistId)
		}

	}

	function searchQueryFunction(searchReturn) {
		return function() {
			return $(".search-q").val().trim() } }

	function displayLoader() {
		$('.search-l, .search-r').css('display', 'none')
		$(document).ready(function() {
			$(".search-l").delay(10).fadeIn()
			$(".search-r").delay("slow").fadeIn()
			$(".search-l").delay(10).fadeOut()
		})
	}

	$(".search-f").submit(function(event) {
		displayLoader()
		searchQuery = searchQueryFunction()
		if(searchQuery().length === 0) {
			event.preventDefault()
		} else {
			event.preventDefault()
			$(".mdl-form-principal-search").addClass("top")
			requestVideoPlaylist(searchQuery(), playlistId) } })

	$(".keyboard_arrow_left").click(function previousPage() {
		displayLoader()
		searchQuery = searchQueryFunction()
		requestVideoPlaylist(searchQuery(), playlistId, prevPageToken); })

	$(".keyboard_arrow_right").click(function nextPage() {
		displayLoader()
		searchQuery = searchQueryFunction()
		requestVideoPlaylist(searchQuery(), playlistId, nextPageToken) })

	function requestVideoPlaylist(search, playlistId, pageToken) {
		var options = {
			part: part,
			maxResults: maxResults,
			playlistId: playlistId,
			q: search,
			key: key }

			if (pageToken !== null) {
				options.pageToken = pageToken; }

	    $.get("https://www.googleapis.com/youtube/v3/search", options, function(data) {

			$.each(data.items, function(index, items) {
				displayResult(items) })
				tokenPagination(data)

		})

	    function tokenPagination(data) {

			if (data.pageInfo.totalResults === 0) {
				var messageResult = "Nada encontrado";
				$('.keyboard_arrow_left, .keyboard_arrow_right').css('display', 'none')
			} else if (data.pageInfo.totalResults === 1) {
				var messageResult = "1 Resultado";
			} else {
				var messageResult = data.pageInfo.totalResults + " Resultados";
			}

			$('.search-r').prepend(
				'<div class="mdl-card">' + 
					'<div class="mdl-card__supporting-text mdl-card--border">' + 
						messageResult + 
					'</div>' + 
				'</div>'
			)

			if (data.pageInfo.totalResults !== 0) {

				prevPageToken = data.prevPageToken;
				$('.keyboard_arrow_left').delay("fast").qcss({
					display: prevPageToken ? 'block' : 'none'
				})

				nextPageToken = data.nextPageToken;
				$('.keyboard_arrow_right').delay("fast").qcss({
					display: nextPageToken ? 'block' : 'none'
				})

			}
		}

		function displayResult(videoSnippet) {
			var title = videoSnippet.snippet.title;
			var description = videoSnippet.snippet.description;
			var publishedAt = videoSnippet.snippet.publishedAt;

			var videoId = videoSnippet.id.videoId;
			if (videoId === undefined) {
				videoId = videoSnippet.id.channelId; }

			var thumbnails = videoSnippet.snippet.thumbnails.medium.url;
			$('.search-r').append(

'<div class="mdl-card mdl-shadow--2dp">' + 

	'<div class="mdl-card__media" style="background-image: url('+ thumbnails +'); min-height: 260px;">' + 
	'</div>' + 

	'<div class="mdl-card__title">' + 
		'<h6>' + title + '</h6>' + 
	'</div>' + 
	'<div class="mdl-card__supporting-text mdl-card--border">' + 
		'<h7>' + description + '</h7>' + 
	'</div>' + 

	'<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect video_url" href="?videoid='+ videoId +'&search=' + search + '">' + 
		'<i class="material-icons">link</i>' + 
	'</a>' + 
'</div>'

			) }
			$(".search-r").html("") }

	getWindowLocation("videoid") ? requestVideoId(getWindowLocation("videoid"), getWindowLocation("search")) : false

	function requestVideoId(videoId, search) {
		var options = {
			part: 'snippet,statistics',
			id: videoId,
			key: key }

	    $.get("https://www.googleapis.com/youtube/v3/videos", options, function(data) {
			$.each(data.items, function(index, items) {
				displayResult(items)
			})
		})

		function displayResult(videoSnippet) {
			$('.video').prepend(
				'<x>x</x>'
			)
			$('.mdl-layout__drawer-button').delay('fast').qcss({
				color: 'rgb(255,255,255)'
			})
			$('.video').append(

			'<div class="mdl-card mdl-card-video mdl-shadow--2dp">' + 

				'<div class="mdl-card__media" style="background-image: url(http://img.youtube.com/vi/' + videoSnippet.id  + '/0.jpg); min-height: 260px;">' + 

					'<iframe id="ytplayer"' + 
					'src="http://www.youtube.com/embed/' + videoSnippet.id + '?autoplay=1&origin=' + getWindowLocation("search") + '"' + 
					'frameborder="0"/>' + 

				'</div>' + 

				'<ul class="counters_modal">' + 
					'<li class="counters">' + 
						videoSnippet.statistics.viewCount + 
						'<spam> Visualições</spam>' + 
					'</li>' + 
					'<li class="counters">' + 
						'<i class="material-icons thumb_alt">thumb_up_alt</i>' + 
						videoSnippet.statistics.likeCount + 
					'</li>' + 
					'<li class="counters">' + 
						'<i class="material-icons thumb_alt thumb_down_alt">thumb_down_alt</i>' + 
						videoSnippet.statistics.dislikeCount + 
					'</li>' + 
				'</ul>' +

			'</div>'

			)

		}

	}

</script>